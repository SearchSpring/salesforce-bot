# Nebo

Say hello to Nebo (Nebulous Cloud Being)

<img style="border-radius: 20px; box-shadow: 3px 3px 5px 0px rgba(173,154,173,1);" src="https://www.gravatar.com/avatar/1abed234f87b8153b2cda61601fbb1f9.jpg">

Nebo is a slackbot that helps us ask salesforce questions without having to go into salesforce.

## Usage
- `/nebo shoes.com`
- `/nebo bigcommerce`
- `/neboidnx A21BCDE5FE33` - find a customer with this key in the Nextopia system
- `/neboidss m6umjp` - find a customer with this ID in the Searchspring system
- `/feature i want this feature please`
- `/fire` - fire checklist
- `/firedown` - fire over checklist
- `/meet` - generate a randomly named meeting invite

## Development

### Prerequisites
- Install Go https://golang.org/doc/install
- Install Node https://nodejs.org/en/download/
- Install vercel `npm install -g vercel`
- Install ngrok `npm install -g ngrok` (because we were too lazy to mock things)

### Run locally
1. Create a .env file for local development
    ```properties
    SF_URL=https://<your url>.my.salesforce.com
    SF_USER=<sf login email>
    SF_PASSWORD=<sf password>
    SF_TOKEN=<sf token>
    SLACK_VERIFICATION_TOKEN=<slack token>
    SLACK_OAUTH_TOKEN=<slack oauth token>
    NX_USER=<nx user>
    NX_PASSWORD=<nx password>
    GCP_SERVICE_ACCOUNT_EMAIL=<nebo gcp service account email>
    GCP_SERVICE_ACCOUNT_PRIVATE_KEY=<nebo gcp base64 encodedservice account private key>
    GDRIVE_FIRE_DOC_FOLDER_ID=<gdrive folder id>
    DEV_MODE=<production | development>
    ```
    * GCP credentials are in 1password `swec > nx-engineering > Google Cloud - Nebo - Service Account credentials.json`
    * To base64 encode the `GCP_SERVICE_ACCOUNT_PRIVATE_KEY`
        1. In a directory outside of the repo create file like `deleteme` then paste in the raw private key from 1password
        2. In your IDE replace all `\n` with actual newlines
        3. In your terminal run `base64 -i deleteme -o deletemetoo`
        4. Copy the text content within `deletemetoo` and set it in your `.env` file
    * If `DEV_MODE` is set to `development` you will be able to test various commands without requiring _all_ env vars to be set to non-blank values
2. Run the server `vercel dev`
3. Run ngrok `ngrok http 3000`
4. Modify your slash command in slack [here](https://api.slack.com/apps/AV2R6PWUS/slash-commands) to point at the URL generated by ngrok in the step above
    * You may need to ask [#engineering](https://searchspring.slack.com/archives/CS8DR87V1) for access

## Tests
Run tests with
```sh
go test ./...
```

## Production
1. Login to vercel
    ```sh
    vercel login machine@searchspring.com
    # It'll send an email to you if you have access
    # You may need to slack #engineering for someone with access to fwd it to you
    ```
2. Ensure all needed secrets exist
    ```sh
    # List secrets
    vercel secrets list
    # Add
    vercel secret add <name> <value>
    # Remove
    vercel secret rm <name> <value>
    ```
    * Vercel requires secrets are set using all lower kabob case so `THIS_EXAMPLE` becomes `this-example`
2. Deploy
    ```sh
    vercel --prod
    ```
